<!DOCTYPE html>
<html lang="zh-TW">
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>領航鈎織 - v22 懸浮定版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { 
            --brand-color: #d3b17d; 
            --brand-light: #f4eee3; 
            /* 需求3: 暖棕色 */
            --brand-done: #b08d55; 
            --bg-main: #ffffff;
        }
        
        /* 需求6: 鎖定雙擊放大 */
        html, body { 
            height: 100%; margin: 0; padding: 0; overflow: hidden; 
            touch-action: manipulation; 
        }

        body { 
            background-color: var(--bg-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "微軟正黑體", sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* 需求5: 佈局結構 */
        .header-fixed { height: 160px; flex-shrink: 0; z-index: 40; }
        
        /* 底部懸浮區：高度設為 0，讓內容不佔位，但按鈕透過絕對定位浮起來 */
        .footer-floating { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            height: 0; z-index: 50; 
            overflow: visible; /* 讓按鈕凸出來 */
        }
        
        #instructionList {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            /* 關鍵：底部留白加多，確保最後一行文字能滑到按鈕上方被看見，而不會被擋死 */
            padding-bottom: 120px; 
        }

        .focus-row { background-color: var(--brand-light); border-left: 6px solid var(--brand-color); transform: scale(1.02); font-weight: 700; z-index: 10; }
        .done-row { opacity: 0.5; filter: grayscale(100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        [contenteditable="true"]:focus { outline: none; border-bottom: 2px dashed var(--brand-color); background: white; }
        
        /* 需求1: 滑動開關 */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e2e8f0; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--brand-color); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* 完成色系 */
        .bg-brand-done { background-color: var(--brand-done) !important; }
        
        /* 動畫 */
        .overlay-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .flash-success { animation: flash 0.5s; }
        @keyframes flash { 0% { background-color: #dcfce7; } 100% { background-color: #ffffff; } }
    </style>
</head>
<body class="flex flex-col">

    <section id="creatorView" class="flex flex-col h-full bg-white z-[100] absolute inset-0">
        <header class="pt-12 pb-2 px-6 flex justify-between items-center bg-white border-b border-slate-50">
            <h1 class="text-2xl font-bold text-slate-800">建立圖解庫</h1>
            <button id="cancelBtn" onclick="switchView('player')" class="text-slate-400 hidden">取消</button>
        </header>
        
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-6 no-scrollbar">
            <div class="space-y-1">
                <label class="text-xs font-bold text-slate-300">作品名稱</label>
                <input id="createName" type="text" class="w-full text-2xl font-bold border-none p-0 focus:ring-0 text-slate-800" placeholder="名稱">
                <div class="h-px bg-slate-100"></div>
            </div>

            <div class="space-y-1">
                <label class="text-xs font-bold text-slate-300">作品說明</label>
                <input id="createDesc" type="text" class="w-full text-base text-slate-600 border-none p-0 focus:ring-0" placeholder="備註工具或注意事項...">
                <div class="h-px bg-slate-100"></div>
            </div>
            
            <div class="flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <div>
                    <h3 class="text-sm font-bold text-slate-700">自動確認針數 (不彈窗)</h3>
                    <p class="text-[10px] text-slate-400">開啟後自動跳過確認步驟</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="autoAcceptToggle" onchange="saveData()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="space-y-2">
                <div class="flex justify-between items-end px-1">
                    <label class="text-xs font-bold text-slate-300 uppercase tracking-widest">圖解指令</label>
                    <span id="lineCounter" class="text-xs font-bold text-brand">(0/100行)</span>
                </div>
                
                <button onclick="smartFormat()" class="w-full py-3 bg-purple-50 text-purple-600 rounded-xl text-sm font-bold border border-purple-100 shadow-sm active:bg-purple-100 transition-colors">
                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> 一鍵整理 (轉繁體+拆行+計算)
                </button>
                
                <textarea id="createSteps" class="w-full min-h-[350px] bg-slate-50 rounded-2xl p-5 font-mono text-base leading-relaxed text-slate-700 focus:bg-white transition-colors resize-none focus:outline-none" oninput="updateLineCount()" placeholder="在此貼上圖解...&#10;R1: 6X (6)&#10;完成後按[一鍵整理]&#10"></textarea>
            </div>
        </div>

        <footer class="p-4 border-t bg-white safe-area-bottom">
            <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
                <button onclick="insertText('R')" class="bg-white border px-6 py-2.5 rounded-xl text-sm font-bold shadow-sm active:bg-slate-50 transition-colors">R</button>
                <button onclick="insertText('X')" class="bg-white border px-6 py-2.5 rounded-xl text-sm font-bold shadow-sm active:bg-slate-50 transition-colors">X短針</button>
                <button onclick="insertText('V')" class="bg-white border px-6 py-2.5 rounded-xl text-sm font-bold shadow-sm active:bg-slate-50 transition-colors">V加針</button>
                <button onclick="insertText('A')" class="bg-white border px-6 py-2.5 rounded-xl text-sm font-bold shadow-sm active:bg-slate-50 transition-colors">A減針</button>
            </div>
            <button onclick="saveAndPlay()" class="w-full bg-[#d3b17d] text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:opacity-90">存入圖解庫</button>
        </footer>
    </section>

    <section id="playerView" class="hidden flex-col h-full bg-slate-50 overflow-hidden">
        <header class="header-fixed pt-12 pb-4 px-6 bg-white border-b shadow-sm z-20">
            <div class="flex justify-between items-end mb-3">
                <div class="bg-slate-100 px-3 py-1.5 rounded-lg font-mono text-sm font-bold text-slate-600">
                    <i class="fa-regular fa-clock"></i> <span id="timerDisplay">00:00</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="switchView('creator')" class="text-xs text-slate-400 border border-slate-200 px-3 py-1 rounded-full">編輯列表</button>
                    <span id="progressText" class="text-brand font-black italic text-2xl">0%</span>
                </div>
            </div>
            <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                <div id="progressBar" class="bg-[#d3b17d] h-full transition-all w-0"></div>
            </div>
            <h1 id="displayTitle" class="mt-3 font-bold text-slate-800 truncate"></h1>
            <p id="displayDesc" class="text-xs text-slate-400 truncate"></p>
        </header>

        <main id="instructionList" class="no-scrollbar"></main>

        <footer class="footer-floating p-6 flex gap-4 pointer-events-none safe-area-bottom items-end justify-center h-auto pb-8">
            <button onclick="togglePause()" class="pointer-events-auto w-16 h-16 bg-[#f4eee3] border border-white/50 rounded-full shadow-lg flex flex-col items-center justify-center active:scale-90 transition-transform z-50">
                <i class="fa-solid fa-pause text-slate-500 text-lg"></i><span class="text-[10px] text-slate-400 font-bold mt-1">暫停</span>
            </button>
            
            <button id="minusBtn" onclick="updateStitch(-1)" class="pointer-events-auto w-16 h-16 bg-[#f4eee3] border border-white/50 text-slate-500 rounded-full shadow-lg hidden active:bg-slate-200 flex items-center justify-center z-50">
                <i class="fa-solid fa-minus text-lg"></i>
            </button>

            <button id="mainBtn" onclick="handleMainAction()" class="pointer-events-auto flex-1 h-16 bg-[#d3b17d] text-white rounded-[2rem] font-bold text-xl shadow-2xl relative overflow-hidden transition-all active:scale-95 flex flex-col items-center justify-center z-50">
                <span id="btnMainText">開始領航</span>
                <span id="btnSubText" class="text-xs block opacity-70 font-normal hidden">點擊計數 (+1)</span>
                <div id="btnProgressBg" class="absolute bottom-0 left-0 h-1.5 bg-black/20 w-0 transition-all"></div>
            </button>
        </footer>
    </section>

    <div id="overlayScreen" class="fixed inset-0 hidden z-[200] flex flex-col items-center justify-center text-center p-6 overlay-fade">
        <div id="overlayContent" class="bg-white/95 backdrop-blur-md inset-0 absolute -z-10"></div>
        <div id="overlayIcon" class="w-24 h-24 bg-[var(--brand-light)] rounded-full flex items-center justify-center mb-6 shadow-sm">
            <i id="iconInner" class="text-4xl text-[#b08d55]"></i>
        </div>
        <h2 id="overlayTitle" class="text-3xl font-bold text-slate-800 mb-2"></h2>
        <p id="overlaySub" class="text-slate-400 mb-10 text-sm"></p>
        <button id="overlayBtn" class="px-12 py-4 bg-[#d3b17d] text-white rounded-full font-bold shadow-xl text-xl active:scale-95 transition-transform"></button>
    </div>

    <div id="stitchModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[150] backdrop-blur-sm p-8">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-center text-slate-400 text-xs font-bold mb-6 tracking-widest uppercase">確認針數</h3>
            <div class="flex items-center justify-center gap-6 mb-8">
                <button onclick="adjustModalCount(-1)" class="w-14 h-14 bg-slate-50 rounded-full font-bold text-2xl active:bg-slate-200">-</button>
                <input id="modalTarget" type="number" class="w-28 text-center text-6xl font-black text-[#d3b17d] border-b-4 border-slate-100 outline-none bg-transparent" value="0">
                <button onclick="adjustModalCount(1)" class="w-14 h-14 bg-slate-50 rounded-full font-bold text-2xl active:bg-slate-200">+</button>
            </div>
            <button onclick="confirmRowStart()" class="w-full py-5 bg-[#d3b17d] text-white rounded-2xl font-bold text-xl active:opacity-90">確認並開始</button>
        </div>
    </div>

    <script>
        let appState = { 
            pattern: { name:"", desc:"", steps:[] }, 
            settings: { autoAccept: true }, // 需求2: 預設開啟
            currentStep: -1, stitchCount: 0, stitchTarget: 0, timerSeconds: 0, isTimerRunning: false 
        };
        let timerInterval = null, pendingIdx = -1;

        function smartFormat() {
            let raw = document.getElementById('createSteps').value;
            if(!raw.trim()) return;

            // 需求4: 簡轉繁
            const map = {
                '环': '環', '针': '針', '钩': '鉤', '线': '線', '长': '長', '短': '短',
                '编': '編', '织': '織', '样': '樣', '图': '圖', '录': '錄', '两': '兩',
                '个': '個', '么': '麼', '这': '這', '里': '裡', '后': '後', '发': '發',
                '转': '轉', '换': '換', '结': '結', '头': '頭', '体': '體', '脚': '腳',
                '起': '起', '圈': '圈', '目': '目'
            };
            raw = raw.replace(/[环针钩线长编织样图录两个么这里后发转换结头体脚]/g, m => map[m] || m);

            const lines = raw.split('\n');
            const newSteps = [];
            lines.forEach(line => {
                line = line.trim(); if(!line) return;
                const rangeMatch = line.match(/^(?:R|r)?(\d+)\s*[-~]\s*(?:R|r)?(\d+)(.*)/i);
                if (rangeMatch) {
                    const start = parseInt(rangeMatch[1]), end = parseInt(rangeMatch[2]), content = rangeMatch[3];
                    for(let i = start; i <= end; i++) newSteps.push(formatSingleLine(`R${i}${content}`));
                } else newSteps.push(formatSingleLine(line));
            });
            
            const textarea = document.getElementById('createSteps');
            textarea.value = newSteps.join('\n');
            updateLineCount();
            textarea.classList.add('flash-success'); 
            setTimeout(() => textarea.classList.remove('flash-success'), 500);
        }

        function formatSingleLine(line) {
            if (/[\(（]\d+[\)）]\s*$/.test(line)) return line;
            const instruction = line.replace(/^(R\d+|Round\s*\d+|行\d+)\s*[:：.]?\s*/i, '').replace(/：/g, ':');
            let total = 0;
            const groupRegex = /(\d+)\s*[\(（](.*?)[\)）]/g;
            let match;
            while ((match = groupRegex.exec(instruction)) !== null) {
                total += parseInt(match[1]) * match[2].split(/[,，]/).filter(s => s.trim()).length;
            }
            const noGroup = instruction.replace(groupRegex, '');
            const simpleRegex = /(\d+)\s*[XVAFxvaf]/g;
            while ((match = simpleRegex.exec(noGroup)) !== null) total += parseInt(match[1]);
            return total > 0 ? `${line} (${total})` : line;
        }

        function init() {
            try {
                // v22 Key
                const saved = localStorage.getItem('knit_nav_v22_float');
                if (saved) {
                    appState = JSON.parse(saved);
                    if (appState.settings?.autoAccept === undefined) appState.settings = { autoAccept: true };
                }
                document.getElementById('autoAcceptToggle').checked = appState.settings.autoAccept;
            } catch(e){}
            if (!appState.pattern.steps.length) switchView('creator');
            else renderPlayerUI();
        }

        function saveData() { 
            appState.settings.autoAccept = document.getElementById('autoAcceptToggle').checked;
            localStorage.setItem('knit_nav_v22_float', JSON.stringify(appState)); 
        }

        function switchView(view) {
            if(view === 'creator') {
                document.getElementById('creatorView').classList.remove('hidden');
                document.getElementById('playerView').classList.add('hidden');
                document.getElementById('createName').value = appState.pattern.name;
                document.getElementById('createDesc').value = appState.pattern.desc || "";
                document.getElementById('createSteps').value = appState.pattern.steps.join('\n');
                if(appState.pattern.steps.length) document.getElementById('cancelBtn').classList.remove('hidden');
                pauseTimer();
            } else {
                document.getElementById('creatorView').classList.add('hidden');
                document.getElementById('playerView').classList.remove('hidden');
                document.getElementById('playerView').classList.add('flex');
                renderPlayerUI();
                scrollToCurrent();
            }
        }

        function updateLineCount() {
            const lines = document.getElementById('createSteps').value.split('\n').filter(l=>l).length;
            document.getElementById('lineCounter').innerText = `(${lines}/100行)`;
        }

        function insertText(t) {
            const a = document.getElementById('createSteps');
            const start = a.selectionStart;
            a.value = a.value.substring(0, start) + t + a.value.substring(a.selectionEnd);
            a.selectionStart = a.selectionEnd = start + t.length;
            updateLineCount(); a.focus();
        }

        // --- 需求2: 編輯保留進度 ---
        function saveAndPlay() {
            const steps = document.getElementById('createSteps').value.split('\n').filter(l=>l.trim());
            if(!steps.length) return alert("請輸入指令");
            appState.pattern.name = document.getElementById('createName').value || "未命名";
            appState.pattern.desc = document.getElementById('createDesc').value || "";
            appState.pattern.steps = steps;
            if (appState.currentStep === undefined) appState.currentStep = -1;
            saveData(); switchView('player');
        }

        function handleMainAction() {
            if(appState.currentStep === -1) prepareRow(0);
            else if(appState.stitchTarget > 0) updateStitch(1);
            else prepareRow(appState.currentStep + 1);
        }

        function prepareRow(idx) {
            // --- 需求7: 完成時 (B方案) 手動 ---
            if(idx >= appState.pattern.steps.length) {
                showOverlay('success'); return;
            }
            pendingIdx = idx;
            const text = appState.pattern.steps[idx];
            let count = 0;
            const totalMatch = text.match(/[\(（](\d+)[\)）]\s*$/);
            if(totalMatch) count = parseInt(totalMatch[1]);
            
            if (document.getElementById('autoAcceptToggle').checked && count > 0) {
                document.getElementById('modalTarget').value = count;
                confirmRowStart(); 
            } else {
                document.getElementById('modalTarget').value = count;
                document.getElementById('stitchModal').classList.remove('hidden');
                pauseTimer();
            }
        }

        function adjustModalCount(d) {
            const i = document.getElementById('modalTarget'); i.value = Math.max(0, (parseInt(i.value)||0)+d);
        }

        function confirmRowStart() {
            appState.stitchTarget = parseInt(document.getElementById('modalTarget').value) || 0;
            appState.stitchCount = 0; appState.currentStep = pendingIdx;
            document.getElementById('stitchModal').classList.add('hidden');
            document.getElementById('mainBtn').classList.remove('bg-brand-done');
            startTimer(); saveData(); renderPlayerUI();
            scrollToCurrent();
        }

        function updateStitch(d) {
            if(navigator.vibrate) navigator.vibrate(30);
            appState.stitchCount = Math.max(0, appState.stitchCount+d);
            saveData(); updateFooter();
            if(appState.stitchTarget > 0 && appState.stitchCount >= appState.stitchTarget) {
                if(navigator.vibrate) navigator.vibrate([50,50,200]);
                document.getElementById('btnMainText').innerText = "本行完成！";
                document.getElementById('btnSubText').classList.add('hidden');
                
                // --- 需求3: 暖棕色 ---
                document.getElementById('mainBtn').classList.add('bg-brand-done');
                
                // --- 需求7: 單行完成 (A方案) 自動消失 ---
                showOverlay('row_done');
                setTimeout(()=> {
                    hideOverlay();
                    prepareRow(appState.currentStep+1);
                }, 1000); 
            }
        }

        function showOverlay(type) {
            const screen = document.getElementById('overlayScreen');
            const icon = document.getElementById('iconInner');
            const title = document.getElementById('overlayTitle');
            const sub = document.getElementById('overlaySub');
            const btn = document.getElementById('overlayBtn');
            
            screen.classList.remove('hidden');
            btn.classList.remove('hidden');

            if(type === 'pause') {
                icon.className = "fa-solid fa-mug-hot text-4xl text-[#b08d55]";
                title.innerText = "暫停中";
                sub.innerText = "計時器已停止，放鬆一下手指吧";
                btn.innerText = "繼續鈎織";
                btn.onclick = togglePause;
            } else if(type === 'row_done') {
                icon.className = "fa-solid fa-check text-4xl text-[#b08d55]";
                title.innerText = "本行完成";
                sub.innerText = "準備進入下一行...";
                btn.classList.add('hidden'); 
            } else if(type === 'success') {
                icon.className = "fa-solid fa-trophy text-4xl text-[#d3b17d]";
                title.innerText = "作品大功告成";
                sub.innerText = "恭喜完成本次任務！";
                btn.innerText = "回到主畫面";
                btn.onclick = () => { appState.currentStep = -1; saveData(); hideOverlay(); switchView('creator'); };
            }
        }

        function hideOverlay() { document.getElementById('overlayScreen').classList.add('hidden'); }

        function renderPlayerUI() {
            document.getElementById('displayTitle').innerText = appState.pattern.name;
            document.getElementById('displayDesc').innerText = appState.pattern.desc;
            const list = document.getElementById('instructionList');
            const current = appState.currentStep;
            list.innerHTML = appState.pattern.steps.map((step, i) => `
                <div id="step-${i}" onclick="if(${i}!==${current})prepareRow(${i})" class="p-5 rounded-2xl border flex items-center gap-4 transition-all duration-300 ${i<current?'done-row bg-slate-50':i===current?'focus-row border-brand shadow-sm':'bg-white shadow-sm border-slate-50'}">
                    <div class="flex-shrink-0 w-8 flex justify-center">${i<current?'<i class="fa-solid fa-check text-[#b08d55]"></i>':`<span class="font-bold text-xs text-brand opacity-60">R${i+1}</span>`}</div>
                    <div class="flex-1 font-mono text-lg outline-none" contenteditable="${i===current}" onblur="appState.pattern.steps[${i}]=this.innerText;saveData()">${step}</div>
                </div>
            `).join('');
            updateFooter(); updateTimerDisplay();
        }

        function updateFooter() {
            const total = appState.pattern.steps.length;
            const pct = total === 0 ? 0 : Math.round((Math.max(0, appState.currentStep)/total)*100);
            document.getElementById('progressBar').style.width = pct+'%';
            document.getElementById('progressText').innerText = pct+'%';
            if(appState.stitchTarget > 0) {
                document.getElementById('btnMainText').innerText = `${appState.stitchCount} / ${appState.stitchTarget}`;
                document.getElementById('btnSubText').innerText = "點擊計數 (+1)";
                document.getElementById('btnSubText').classList.remove('hidden');
                document.getElementById('minusBtn').classList.remove('hidden');
                document.getElementById('btnProgressBg').style.width = (appState.stitchCount/appState.stitchTarget*100)+'%';
            } else {
                const isStart = appState.currentStep === -1;
                document.getElementById('btnMainText').innerText = isStart ? "開始領航" : "下一行";
                document.getElementById('btnSubText').classList.add('hidden');
                document.getElementById('minusBtn').classList.add('hidden');
                document.getElementById('btnProgressBg').style.width = '0%';
            }
        }

        function scrollToCurrent() {
            setTimeout(() => {
                const el = document.getElementById(`step-${appState.currentStep}`);
                if(el) el.scrollIntoView({ behavior:'smooth', block:'center'});
            }, 300);
        }

        function startTimer() {
            if(appState.isTimerRunning) return;
            appState.isTimerRunning = true; hideOverlay();
            timerInterval = setInterval(() => { appState.timerSeconds++; updateTimerDisplay(); }, 1000);
        }
        function pauseTimer() { appState.isTimerRunning = false; clearInterval(timerInterval); }
        function togglePause() { if(appState.isTimerRunning) { pauseTimer(); showOverlay('pause'); } else startTimer(); }
        function updateTimerDisplay() {
            const m = Math.floor(appState.timerSeconds/60).toString().padStart(2,'0'), s = (appState.timerSeconds%60).toString().padStart(2,'0');
            document.getElementById('timerDisplay').innerText = `${m}:${s}`;
        }
        window.addEventListener('load', () => setTimeout(init, 100));
    </script>
</body>
</html>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é ˜èˆªéˆç¹” - v13</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --brand-color: #d3b17d; --brand-light: #f4eee3; }
        
        /* åŸºç¤ä½ˆå±€ï¼šé˜²æ­¢æ•´å€‹é é¢å½ˆè·³ */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; /* é–å®šæœ€å¤–å±¤ï¼Œæ”¹ç”¨å…§éƒ¨æ»¾å‹• */
        }

        body { 
            background-color: #ffffff; 
            font-family: -apple-system, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* æ²‰æµ¸å¼å°èˆªæ¨£å¼ */
        .focus-row { 
            background-color: var(--brand-light); 
            border-left: 6px solid var(--brand-color); 
            transform: scale(1.02); 
            font-weight: 700; 
            z-index: 10; 
        }
        
        .done-row { 
            opacity: 0.6; 
            filter: grayscale(100%); 
        }

        /* é—œéµï¼šè®“åˆ—è¡¨å¯ä»¥é †æš¢æ»‘å‹• */
        #instructionList {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOS é †æ»‘æ»¾å‹•å¿…å‚™ */
            scroll-behavior: smooth;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        [contenteditable="true"]:focus { 
            outline: none; 
            border-bottom: 2px dashed var(--brand-color); 
            background: white; 
        }

        /* å®‰å…¨å€åŸŸåº•éƒ¨é©é… */
        .safe-area-inset-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="flex flex-col">

    <section id="creatorView" class="flex flex-col h-full bg-white z-50 absolute inset-0">
        <header class="pt-10 pb-2 px-6 flex justify-between items-center bg-white border-b border-slate-50">
            <h1 class="text-2xl font-bold">å»ºç«‹åœ–è§£åº«</h1>
            <button id="cancelBtn" onclick="switchView('player')" class="text-slate-400 hidden">å–æ¶ˆ</button>
        </header>
        
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-6 no-scrollbar">
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-300 uppercase">åœ–è§£åç¨±</label>
                <input id="createName" type="text" class="w-full text-2xl font-bold border-none p-0 focus:ring-0" placeholder="é ˜èˆªé …ç›®åç¨±">
                <div class="h-px bg-slate-100"></div>
            </div>
            
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-300 uppercase">åœ–è§£æŒ‡ä»¤</label>
                <span id="lineCounter" class="float-right text-xs text-brand font-bold">(0/100è¡Œ)</span>
                <textarea id="createSteps" class="w-full min-h-[400px] bg-slate-50 rounded-2xl p-5 font-mono resize-none focus:bg-white transition-all" oninput="updateLineCount()" placeholder="R1: 6X&#10;R2: 6V"></textarea>
            </div>
        </div>

        <footer class="p-4 border-t bg-white safe-area-inset-bottom">
            <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
                <button onclick="insertText('Rx')" class="bg-white border px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm active:scale-95 transition-transform">Rx</button>
                <button onclick="insertText('X')" class="bg-white border px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm active:scale-95 transition-transform">XçŸ­é‡</button>
                <button onclick="insertText('V')" class="bg-white border px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm active:scale-95 transition-transform">VåŠ é‡</button>
                <button onclick="insertText('F')" class="bg-white border px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm active:scale-95 transition-transform">Fé•·é‡</button>
            </div>
            <button onclick="saveAndPlay()" class="w-full bg-[#d3b17d] text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:opacity-90">å­˜å…¥é ˜èˆªåº«</button>
        </footer>
    </section>

    <section id="playerView" class="hidden flex-col h-full bg-slate-50">
        <header class="pt-10 pb-4 px-6 bg-white border-b shadow-sm z-20">
            <div class="flex justify-between items-end mb-3">
                <div class="bg-slate-100 px-3 py-1.5 rounded-lg font-mono text-sm font-bold text-slate-600 flex items-center gap-2">
                    <i class="fa-regular fa-clock"></i> <span id="timerDisplay">00:00</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="switchView('creator')" class="text-xs text-slate-400 border border-slate-200 px-3 py-1 rounded-full">ç·¨è¼¯</button>
                    <span id="progressText" class="text-[#d3b17d] font-black italic text-2xl">0%</span>
                </div>
            </div>
            <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                <div id="progressBar" class="bg-[#d3b17d] h-full transition-all duration-500 w-0"></div>
            </div>
            <h1 id="displayTitle" class="mt-3 font-bold text-slate-800 truncate"></h1>
        </header>

        <main id="instructionList" class="p-4 space-y-3 no-scrollbar pb-64">
            </main>

        <footer class="fixed bottom-0 left-0 right-0 p-6 flex gap-4 pointer-events-none z-30 safe-area-inset-bottom">
            <button onclick="togglePause()" class="pointer-events-auto w-16 h-16 bg-white border border-slate-100 rounded-full shadow-xl flex flex-col items-center justify-center active:scale-90 transition-transform">
                <i class="fa-solid fa-pause text-slate-500"></i><span class="text-[10px] text-slate-400 font-bold mt-0.5">æš«åœ</span>
            </button>
            <button id="minusBtn" onclick="updateStitch(-1)" class="pointer-events-auto w-14 h-14 bg-slate-100 text-slate-500 rounded-full shadow-lg hidden active:bg-slate-200"><i class="fa-solid fa-minus"></i></button>
            <button id="mainBtn" onclick="handleMainAction()" class="pointer-events-auto flex-1 h-20 bg-[#d3b17d] text-white rounded-[2rem] font-bold text-2xl shadow-2xl relative overflow-hidden transition-all active:scale-95">
                <span id="btnMainText">é–‹å§‹</span>
                <span id="btnSubText" class="text-xs block opacity-70 font-normal hidden">é»æ“Šè¨ˆæ•¸ (+1)</span>
                <div id="btnProgressBg" class="absolute bottom-0 left-0 h-1.5 bg-black/20 w-0 transition-all"></div>
            </button>
        </footer>
    </section>

    <div id="stitchModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-8">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl transition-all scale-up">
            <h3 class="text-center text-slate-400 text-xs font-bold mb-6 uppercase tracking-widest">é ˜èˆªåµæ¸¬é‡æ•¸</h3>
            <div class="flex items-center justify-center gap-6 mb-8">
                <button onclick="adjustModalCount(-1)" class="w-14 h-14 bg-slate-50 rounded-full font-bold text-2xl active:bg-slate-200 transition-colors">-</button>
                <input id="modalTarget" type="number" class="w-28 text-center text-6xl font-black text-[#d3b17d] border-b-4 border-slate-100 outline-none bg-transparent" value="0">
                <button onclick="adjustModalCount(1)" class="w-14 h-14 bg-slate-50 rounded-full font-bold text-2xl active:bg-slate-200 transition-colors">+</button>
            </div>
            <button onclick="confirmRowStart()" class="w-full py-5 bg-[#d3b17d] text-white rounded-2xl font-bold text-xl shadow-lg active:opacity-90 transition-all">ç¢ºèªé–‹å§‹</button>
        </div>
    </div>

    <div id="pauseOverlay" class="fixed inset-0 bg-white/95 hidden z-[110] flex flex-col items-center justify-center text-center">
        <div class="w-24 h-24 bg-[var(--brand-light)] rounded-full flex items-center justify-center mb-6">
            <i class="fa-solid fa-mug-hot text-4xl text-[#d3b17d]"></i>
        </div>
        <h2 class="text-3xl font-bold text-slate-800 mb-2">é ˜èˆªæš«åœä¸­</h2>
        <p class="text-slate-400 mb-10">è¶ç¾åœ¨å–å£æ°´ã€å‹•å‹•æ‰‹æŒ‡å§</p>
        <button onclick="togglePause()" class="px-12 py-4 bg-[#d3b17d] text-white rounded-full font-bold shadow-xl text-xl active:scale-95 transition-transform">ç¹¼çºŒç·¨ç¹”</button>
    </div>

    <script>
        let appState = { 
            pattern: { name:"", steps:[] }, 
            currentStep: -1, 
            stitchCount: 0, 
            stitchTarget: 0, 
            timerSeconds: 0, 
            isTimerRunning: false 
        };
        let timerInterval = null, pendingIdx = -1;

        // --- åˆå§‹åŒ– & æ–·é»è¨˜æ†¶ ---
        function init() {
            try {
                const saved = localStorage.getItem('knit_nav_v13_scroll');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if(parsed && parsed.pattern) appState = parsed;
                }
            } catch(e){}
            
            if (!appState.pattern.steps.length) {
                switchView('creator');
            } else {
                renderPlayerUI();
                // ä¸€éµæ¢å¾©ï¼šè‡ªå‹•æ»¾å‹•åˆ°ä¸Šæ¬¡çµæŸçš„è¡Œæ•¸
                scrollToCurrent();
            }
        }

        function saveData() { localStorage.setItem('knit_nav_v13_scroll', JSON.stringify(appState)); }

        // --- è¦–åœ–åˆ‡æ› ---
        function switchView(view) {
            const creator = document.getElementById('creatorView');
            const player = document.getElementById('playerView');
            
            if(view === 'creator') {
                creator.classList.remove('hidden');
                player.classList.add('hidden');
                document.getElementById('createName').value = appState.pattern.name;
                document.getElementById('createSteps').value = appState.pattern.steps.join('\n');
                if(appState.pattern.steps.length) document.getElementById('cancelBtn').classList.remove('hidden');
                pauseTimer();
            } else {
                creator.classList.add('hidden');
                player.classList.remove('hidden');
                player.classList.add('flex');
                renderPlayerUI();
                scrollToCurrent();
            }
        }

        function updateLineCount() {
            const lines = document.getElementById('createSteps').value.split('\n').filter(l=>l).length;
            document.getElementById('lineCounter').innerText = `(${lines}/100è¡Œ)`;
            document.getElementById('lineCounter').classList.toggle('text-red-500', lines > 100);
        }

        function insertText(t) {
            const a = document.getElementById('createSteps');
            const start = a.selectionStart;
            a.value = a.value.substring(0, start) + t + a.value.substring(a.selectionEnd);
            a.selectionStart = a.selectionEnd = start + t.length;
            updateLineCount(); a.focus();
        }

        function saveAndPlay() {
            const steps = document.getElementById('createSteps').value.split('\n').filter(l=>l.trim());
            if(!steps.length) return alert("è«‹è¼¸å…¥åœ–è§£å…§å®¹");
            appState.pattern = { name: document.getElementById('createName').value || "æœªå‘½åä½œå“", steps };
            appState.currentStep = -1; 
            saveData(); 
            switchView('player');
        }

        // --- é ˜èˆªæ ¸å¿ƒæ§åˆ¶ ---
        function handleMainAction() {
            if(appState.currentStep === -1) prepareRow(0);
            else if(appState.stitchTarget > 0) updateStitch(1);
            else prepareRow(appState.currentStep + 1);
        }

        function prepareRow(idx) {
            if(idx >= appState.pattern.steps.length) {
                alert("ğŸ‰ ä½œå“é ˜èˆªå®Œæˆï¼"); appState.currentStep = -1; saveData(); renderPlayerUI(); return;
            }
            pendingIdx = idx;
            const rawText = appState.pattern.steps[idx];
            const cleanText = rawText.replace(/^(R\d+|Round\s*\d+|è¡Œ\d+)\s*[:ï¼š.]?\s*/i, '').replace(/ï¼š/g, ':');
            
            let count = 0;
            const totalMatch = rawText.match(/[\(ï¼ˆ](\d+)[\)ï¼‰]\s*$/);
            if(totalMatch) {
                count = parseInt(totalMatch[1]);
            } else {
                const groupMatch = cleanText.match(/(\d+)\s*[\(ï¼ˆ](.*?)[\)ï¼‰]/);
                if(groupMatch) {
                    count = parseInt(groupMatch[1]) * groupMatch[2].split(/[,ï¼Œ]/).filter(s=>s.trim()).length;
                } else {
                    const V = cleanText.match(/(\d+)\s*V/i), F = cleanText.match(/(\d+)\s*F/i), X = cleanText.match(/(\d+)\s*X/i);
                    if(V) count = parseInt(V[1])*2; else if(F||X) count = parseInt((F||X)[1]);
                }
            }
            document.getElementById('modalTarget').value = count;
            document.getElementById('stitchModal').classList.remove('hidden');
            pauseTimer();
        }

        function adjustModalCount(d) {
            const i = document.getElementById('modalTarget'); 
            i.value = Math.max(0, (parseInt(i.value) || 0) + d);
        }

        function confirmRowStart() {
            appState.stitchTarget = parseInt(document.getElementById('modalTarget').value) || 0;
            appState.stitchCount = 0; 
            appState.currentStep = pendingIdx;
            document.getElementById('stitchModal').classList.add('hidden');
            document.getElementById('mainBtn').classList.remove('bg-green-500');
            startTimer(); saveData(); renderPlayerUI();
            scrollToCurrent();
        }

        function updateStitch(d) {
            if(navigator.vibrate) navigator.vibrate(30);
            appState.stitchCount = Math.max(0, appState.stitchCount + d);
            saveData(); updateFooter();
            
            if(appState.stitchTarget > 0 && appState.stitchCount >= appState.stitchTarget) {
                if(navigator.vibrate) navigator.vibrate([50,50,200]);
                document.getElementById('btnMainText').innerText = "å®Œæˆï¼";
                document.getElementById('btnSubText').classList.add('hidden');
                document.getElementById('mainBtn').classList.add('bg-green-500');
                setTimeout(()=> prepareRow(appState.currentStep + 1), 600);
            }
        }

        // --- UI æ¸²æŸ“ ---
        function renderPlayerUI() {
            document.getElementById('displayTitle').innerText = appState.pattern.name;
            const list = document.getElementById('instructionList');
            const current = appState.currentStep;
            
            list.innerHTML = appState.pattern.steps.map((step, i) => `
                <div id="step-${i}" onclick="if(${i}!==${current})prepareRow(${i})" class="p-5 rounded-2xl border flex items-center gap-4 transition-all duration-300 ${i < current ? 'done-row bg-slate-50 border-slate-100' : i === current ? 'focus-row border-brand shadow-md' : 'bg-white border-slate-50 shadow-sm'}">
                    <div class="flex-shrink-0 w-8 flex justify-center">
                        ${i < current ? '<i class="fa-solid fa-check text-green-400 text-lg"></i>' : `<span class="font-bold text-xs text-brand opacity-60">R${i+1}</span>`}
                    </div>
                    <div class="flex-1 font-mono text-lg outline-none" contenteditable="${i === current}" onblur="appState.pattern.steps[${i}]=this.innerText;saveData()">${step}</div>
                </div>
            `).join('');
            updateFooter(); updateTimerDisplay();
        }

        function updateFooter() {
            const total = appState.pattern.steps.length;
            const completed = Math.max(0, appState.currentStep);
            const pct = total === 0 ? 0 : Math.round((completed / total) * 100);
            
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressText').innerText = pct + '%';
            
            if(appState.stitchTarget > 0) {
                document.getElementById('btnMainText').innerText = `${appState.stitchCount} / ${appState.stitchTarget}`;
                document.getElementById('btnSubText').classList.remove('hidden');
                document.getElementById('minusBtn').classList.remove('hidden');
                document.getElementById('btnProgressBg').style.width = (appState.stitchCount / appState.stitchTarget * 100) + '%';
            } else {
                document.getElementById('btnMainText').innerText = appState.currentStep === -1 ? "é–‹å§‹é ˜èˆª" : "ä¸‹ä¸€è¡Œ";
                document.getElementById('btnSubText').classList.add('hidden');
                document.getElementById('minusBtn').classList.add('hidden');
                document.getElementById('btnProgressBg').style.width = '0%';
            }
        }

        function scrollToCurrent() {
            setTimeout(() => {
                const el = document.getElementById(`step-${appState.currentStep}`);
                if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        // --- è¨ˆæ™‚ & æš«åœ ---
        function startTimer() {
            if(appState.isTimerRunning) return;
            appState.isTimerRunning = true;
            document.getElementById('pauseOverlay').classList.add('hidden');
            timerInterval = setInterval(() => { appState.timerSeconds++; updateTimerDisplay(); }, 1000);
        }
        function pauseTimer() { appState.isTimerRunning = false; clearInterval(timerInterval); }
        function togglePause() { 
            if(appState.isTimerRunning) { 
                pauseTimer(); 
                document.getElementById('pauseOverlay').classList.remove('hidden'); 
            } else startTimer(); 
        }
        function updateTimerDisplay() {
            const m = Math.floor(appState.timerSeconds/60).toString().padStart(2,'0');
            const s = (appState.timerSeconds%60).toString().padStart(2,'0');
            document.getElementById('timerDisplay').innerText = `${m}:${s}`;
        }

        // æ‰‹æ©Ÿç‰ˆï¼šå»¶é²å•Ÿå‹•ç¢ºä¿é«˜åº¦è¨ˆç®—æ­£ç¢º
        window.addEventListener('load', () => setTimeout(init, 100));
    </script>
</body>
</html>

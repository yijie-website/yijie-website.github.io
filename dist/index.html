<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é ˜èˆªéˆç¹” - v15 ç¹é«”ä¸­æ–‡ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --brand-color: #d3b17d; --brand-light: #f4eee3; --accent-purple: #8b5cf6; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        /* å¼·åˆ¶æŒ‡å®šç¹é«”ä¸­æ–‡å­—é«”å„ªå…ˆ */
        body { background-color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Heiti TC", sans-serif; -webkit-tap-highlight-color: transparent; }
        .focus-row { background-color: var(--brand-light); border-left: 6px solid var(--brand-color); transform: scale(1.02); font-weight: 700; z-index: 10; }
        .done-row { opacity: 0.6; filter: grayscale(100%); }
        #instructionList { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        [contenteditable="true"]:focus { outline: none; border-bottom: 2px dashed var(--brand-color); background: white; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .flash-success { animation: flash 0.5s; }
        @keyframes flash { 0% { background-color: #dcfce7; } 100% { background-color: #f8fafc; } }
    </style>
</head>
<body class="flex flex-col">

    <section id="creatorView" class="flex flex-col h-full bg-white z-50 absolute inset-0">
        <header class="pt-10 pb-2 px-6 flex justify-between items-center bg-white border-b border-slate-50">
            <h1 class="text-2xl font-bold">å»ºç«‹åœ–è§£åº«</h1>
            <button id="cancelBtn" onclick="switchView('player')" class="text-slate-400 hidden">å–æ¶ˆ</button>
        </header>
        
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-6 no-scrollbar">
            <div class="space-y-1">
                <label class="text-xs font-bold text-slate-300 uppercase">ä½œå“åç¨±</label>
                <input id="createName" type="text" class="w-full text-2xl font-bold border-none p-0 focus:ring-0" placeholder="ä¾‹å¦‚ï¼šé ˜èˆªå°ç†Š">
                <div class="h-px bg-slate-100"></div>
            </div>

            <div class="space-y-1">
                <label class="text-xs font-bold text-slate-300 uppercase">é …ç›®æè¿°</label>
                <input id="createDesc" type="text" class="w-full text-base text-slate-600 border-none p-0 focus:ring-0" placeholder="å‚™è¨»ç”¨ç·šã€é‡è™Ÿ...">
                <div class="h-px bg-slate-100"></div>
            </div>
            
            <div class="space-y-2">
                <div class="flex justify-between items-end">
                    <label class="text-xs font-bold text-slate-300 uppercase">åœ–è§£æŒ‡ä»¤</label>
                    <span id="lineCounter" class="text-xs text-brand font-bold">(0/100è¡Œ)</span>
                </div>
                
                <button onclick="smartFormat()" class="w-full py-2 bg-purple-50 text-purple-600 rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-purple-100 transition-colors border border-purple-100">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> ä¸€éµæ•´ç†æ ¼å¼ (æ‹†è¡Œ+ç®—é‡æ•¸)
                </button>

                <textarea id="createSteps" class="w-full min-h-[300px] bg-slate-50 rounded-2xl p-5 font-mono resize-none focus:bg-white transition-colors" oninput="updateLineCount()" placeholder="åœ¨æ­¤è²¼ä¸ŠåŸå§‹åœ–è§£...&#10;ä¾‹å¦‚ï¼š&#10;R1: 6X&#10;R2: 6V&#10;R6-9: 36X"></textarea>
            </div>
        </div>

        <footer class="p-4 border-t bg-white safe-area-bottom">
            <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
                <button onclick="insertText('Rx')" class="bg-white border px-5 py-2 rounded-xl text-sm font-bold shadow-sm active:scale-95">Rx</button>
                <button onclick="insertText('X')" class="bg-white border px-5 py-2 rounded-xl text-sm font-bold shadow-sm active:scale-95">XçŸ­é‡</button>
                <button onclick="insertText('V')" class="bg-white border px-5 py-2 rounded-xl text-sm font-bold shadow-sm active:scale-95">VåŠ é‡</button>
                <button onclick="insertText('A')" class="bg-white border px-5 py-2 rounded-xl text-sm font-bold shadow-sm active:scale-95">Aæ¸›é‡</button>
            </div>
            <button onclick="saveAndPlay()" class="w-full bg-[#d3b17d] text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:opacity-90">å­˜å…¥åœ–è§£åº«</button>
        </footer>
    </section>

    <section id="playerView" class="hidden flex-col h-full bg-slate-50">
        <header class="pt-10 pb-4 px-6 bg-white border-b shadow-sm z-20">
            <div class="flex justify-between items-end mb-3">
                <div class="bg-slate-100 px-3 py-1.5 rounded-lg font-mono text-sm font-bold text-slate-600">
                    <i class="fa-regular fa-clock"></i> <span id="timerDisplay">00:00</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="switchView('creator')" class="text-xs text-slate-400 border px-3 py-1 rounded-full">ç·¨è¼¯</button>
                    <span id="progressText" class="text-brand font-black italic text-2xl">0%</span>
                </div>
            </div>
            <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                <div id="progressBar" class="bg-[#d3b17d] h-full transition-all w-0"></div>
            </div>
            <h1 id="displayTitle" class="mt-3 font-bold text-slate-800 truncate"></h1>
            <p id="displayDesc" class="text-xs text-slate-400 truncate"></p>
        </header>

        <main id="instructionList" class="p-4 space-y-3 pb-64 no-scrollbar"></main>

        <footer class="fixed bottom-0 left-0 right-0 p-6 flex gap-4 pointer-events-none z-30 safe-area-bottom">
            <button onclick="togglePause()" class="pointer-events-auto w-16 h-16 bg-white border border-slate-100 rounded-full shadow-xl flex flex-col items-center justify-center active:scale-90 transition-transform">
                <i class="fa-solid fa-pause text-slate-500"></i><span class="text-[10px] text-slate-400 font-bold">æš«åœ</span>
            </button>
            <button id="minusBtn" onclick="updateStitch(-1)" class="pointer-events-auto w-14 h-14 bg-slate-100 text-slate-500 rounded-full shadow-lg hidden active:bg-slate-200"><i class="fa-solid fa-minus"></i></button>
            <button id="mainBtn" onclick="handleMainAction()" class="pointer-events-auto flex-1 h-20 bg-[#d3b17d] text-white rounded-[2rem] font-bold text-2xl shadow-2xl relative overflow-hidden transition-all active:scale-95">
                <span id="btnMainText">é–‹å§‹</span>
                <span id="btnSubText" class="text-xs block opacity-70 hidden">é»æ“Šè¨ˆæ•¸ (+1)</span>
                <div id="btnProgressBg" class="absolute bottom-0 left-0 h-1.5 bg-black/20 w-0 transition-all"></div>
            </button>
        </footer>
    </section>

    <div id="stitchModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-8">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-center text-slate-400 text-xs font-bold mb-6 uppercase tracking-widest">ä¸‹ä¸€è¡Œé‡æ•¸</h3>
            <div class="flex items-center justify-center gap-6 mb-8">
                <button onclick="adjustModalCount(-1)" class="w-14 h-14 bg-slate-50 rounded-full font-bold text-2xl active:bg-slate-200">-</button>
                <input id="modalTarget" type="number" class="w-28 text-center text-6xl font-black text-[#d3b17d] border-b-4 border-slate-100 outline-none bg-transparent" value="0">
                <button onclick="adjustModalCount(1)" class="w-14 h-14 bg-slate-50 rounded-full font-bold text-2xl active:bg-slate-200">+</button>
            </div>
            <button onclick="confirmRowStart()" class="w-full py-5 bg-[#d3b17d] text-white rounded-2xl font-bold text-xl shadow-lg active:opacity-90">ç¢ºèªé ˜èˆª</button>
        </div>
    </div>

    <div id="pauseOverlay" class="fixed inset-0 bg-white/95 hidden z-[110] flex flex-col items-center justify-center text-center">
        <i class="fa-solid fa-mug-hot text-6xl text-[#d3b17d] mb-4"></i>
        <h2 class="text-3xl font-bold text-slate-800 mb-2">é ˜èˆªæš«åœä¸­</h2>
        <button onclick="togglePause()" class="px-12 py-4 bg-[#d3b17d] text-white rounded-full font-bold shadow-xl text-xl">ç¹¼çºŒ</button>
    </div>

    <script>
        let appState = { pattern: { name:"", desc:"", steps:[] }, currentStep: -1, stitchCount: 0, stitchTarget: 0, timerSeconds: 0, isTimerRunning: false };
        let timerInterval = null, pendingIdx = -1;

        // --- æ™ºæ…§æ•´ç† (Smart Format) ---
        function smartFormat() {
            const raw = document.getElementById('createSteps').value;
            if(!raw.trim()) return alert("è«‹å…ˆè¼¸å…¥å…§å®¹");

            const lines = raw.split('\n');
            const newSteps = [];

            lines.forEach(line => {
                line = line.trim();
                if(!line) return;

                const rangeMatch = line.match(/^(?:R|r)?(\d+)\s*[-~]\s*(?:R|r)?(\d+)(.*)/i);
                if (rangeMatch) {
                    const start = parseInt(rangeMatch[1]);
                    const end = parseInt(rangeMatch[2]);
                    const content = rangeMatch[3];

                    if(start < end && (end - start) < 50) {
                        for(let i = start; i <= end; i++) {
                            newSteps.push(formatSingleLine(`R${i}${content}`));
                        }
                    } else {
                        newSteps.push(formatSingleLine(line));
                    }
                } else {
                    newSteps.push(formatSingleLine(line));
                }
            });

            const result = newSteps.join('\n');
            const textarea = document.getElementById('createSteps');
            textarea.value = result;
            updateLineCount();
            
            textarea.classList.add('flash-success');
            setTimeout(() => textarea.classList.remove('flash-success'), 500);
        }

        function formatSingleLine(line) {
            if (/[\(ï¼ˆ]\d+[\)ï¼‰]\s*$/.test(line)) return line;

            const instructionOnly = line.replace(/^(R\d+|Round\s*\d+|è¡Œ\d+)\s*[:ï¼š.]?\s*/i, '');
            const cleanText = instructionOnly.replace(/ï¼š/g, ':');
            let total = 0;

            const groupRegex = /(\d+)\s*[\(ï¼ˆ](.*?)[\)ï¼‰]/g;
            let match;
            while ((match = groupRegex.exec(cleanText)) !== null) {
                const multiplier = parseInt(match[1]);
                const content = match[2];
                const items = content.split(/[,ï¼Œ]/).filter(s => s.trim()).length;
                total += multiplier * items;
            }

            const noGroupText = cleanText.replace(groupRegex, '');
            const simpleRegex = /(\d+)\s*[XVAFxvaf]/g;
            while ((match = simpleRegex.exec(noGroupText)) !== null) {
                total += parseInt(match[1]);
            }

            if (total > 0) return `${line} (${total})`;
            return line;
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        function init() {
            try {
                // Key: v15_tc
                const saved = localStorage.getItem('knit_nav_v15_tc');
                if (saved) appState = JSON.parse(saved);
            } catch(e){}
            if (!appState.pattern.steps.length) switchView('creator');
            else renderPlayerUI();
        }

        function saveData() { localStorage.setItem('knit_nav_v15_tc', JSON.stringify(appState)); }

        function switchView(view) {
            if(view === 'creator') {
                document.getElementById('creatorView').classList.remove('hidden');
                document.getElementById('playerView').classList.add('hidden');
                document.getElementById('createName').value = appState.pattern.name;
                document.getElementById('createDesc').value = appState.pattern.desc;
                document.getElementById('createSteps').value = appState.pattern.steps.join('\n');
                if(appState.pattern.steps.length) document.getElementById('cancelBtn').classList.remove('hidden');
                pauseTimer();
            } else {
                document.getElementById('creatorView').classList.add('hidden');
                document.getElementById('playerView').classList.remove('hidden');
                renderPlayerUI();
                scrollToCurrent();
            }
        }

        function updateLineCount() {
            const lines = document.getElementById('createSteps').value.split('\n').filter(l=>l).length;
            document.getElementById('lineCounter').innerText = `(${lines}/100è¡Œ)`;
        }

        function insertText(t) {
            const a = document.getElementById('createSteps');
            const start = a.selectionStart;
            a.value = a.value.substring(0, start) + t + a.value.substring(a.selectionEnd);
            a.selectionStart = a.selectionEnd = start + t.length;
            updateLineCount(); a.focus();
        }

        function saveAndPlay() {
            const steps = document.getElementById('createSteps').value.split('\n').filter(l=>l.trim());
            if(!steps.length) return alert("è«‹è¼¸å…¥æŒ‡ä»¤");
            appState.pattern = { name: document.getElementById('createName').value || "æœªå‘½å", desc: document.getElementById('createDesc').value || "", steps };
            appState.currentStep = -1; 
            saveData(); switchView('player');
        }

        function handleMainAction() {
            if(appState.currentStep === -1) prepareRow(0);
            else if(appState.stitchTarget > 0) updateStitch(1);
            else prepareRow(appState.currentStep + 1);
        }

        function prepareRow(idx) {
            if(idx >= appState.pattern.steps.length) {
                alert("ğŸ‰ ä½œå“é ˜èˆªå®Œæˆï¼"); appState.currentStep = -1; saveData(); renderPlayerUI(); return;
            }
            pendingIdx = idx;
            const text = appState.pattern.steps[idx];
            
            let count = 0;
            const totalMatch = text.match(/[\(ï¼ˆ](\d+)[\)ï¼‰]\s*$/);
            if(totalMatch) count = parseInt(totalMatch[1]);
            
            document.getElementById('modalTarget').value = count;
            document.getElementById('stitchModal').classList.remove('hidden');
            pauseTimer();
        }

        function adjustModalCount(d) {
            const i = document.getElementById('modalTarget'); i.value = Math.max(0, (parseInt(i.value)||0)+d);
        }

        function confirmRowStart() {
            appState.stitchTarget = parseInt(document.getElementById('modalTarget').value) || 0;
            appState.stitchCount = 0; appState.currentStep = pendingIdx;
            document.getElementById('stitchModal').classList.add('hidden');
            document.getElementById('mainBtn').classList.remove('bg-green-500');
            startTimer(); saveData(); renderPlayerUI();
            scrollToCurrent();
        }

        function updateStitch(d) {
            if(navigator.vibrate) navigator.vibrate(30);
            appState.stitchCount = Math.max(0, appState.stitchCount+d);
            saveData(); updateFooter();
            if(appState.stitchTarget > 0 && appState.stitchCount >= appState.stitchTarget) {
                if(navigator.vibrate) navigator.vibrate([50,50,200]);
                document.getElementById('btnMainText').innerText = "å®Œæˆï¼";
                document.getElementById('btnSubText').classList.add('hidden');
                document.getElementById('mainBtn').classList.add('bg-green-500');
                setTimeout(()=> prepareRow(appState.currentStep+1), 600);
            }
        }

        function renderPlayerUI() {
            document.getElementById('displayTitle').innerText = appState.pattern.name;
            document.getElementById('displayDesc').innerText = appState.pattern.desc;
            const list = document.getElementById('instructionList');
            const current = appState.currentStep;
            list.innerHTML = appState.pattern.steps.map((step, i) => `
                <div id="step-${i}" onclick="if(${i}!==${current})prepareRow(${i})" class="p-5 rounded-2xl border flex items-center gap-4 transition-all duration-300 ${i<current?'done-row bg-slate-50':i===current?'focus-row border-brand shadow-md':'bg-white shadow-sm'}">
                    <div class="flex-shrink-0 w-8 flex justify-center">${i<current?'<i class="fa-solid fa-check text-green-400"></i>':`<span class="font-bold text-xs text-brand opacity-60">R${i+1}</span>`}</div>
                    <div class="flex-1 font-mono text-lg outline-none" contenteditable="${i===current}" onblur="appState.pattern.steps[${i}]=this.innerText;saveData()">${step}</div>
                </div>
            `).join('');
            updateFooter(); updateTimerDisplay();
        }

        function updateFooter() {
            const total = appState.pattern.steps.length;
            const pct = total === 0 ? 0 : Math.round((Math.max(0, appState.currentStep)/total)*100);
            document.getElementById('progressBar').style.width = pct+'%';
            document.getElementById('progressText').innerText = pct+'%';
            if(appState.stitchTarget > 0) {
                document.getElementById('btnMainText').innerText = `${appState.stitchCount} / ${appState.stitchTarget}`;
                document.getElementById('btnSubText').classList.remove('hidden');
                document.getElementById('minusBtn').classList.remove('hidden');
                document.getElementById('btnProgressBg').style.width = (appState.stitchCount/appState.stitchTarget*100)+'%';
            } else {
                document.getElementById('btnMainText').innerText = appState.currentStep===-1?"é–‹å§‹é ˜èˆª":"ä¸‹ä¸€è¡Œ";
                document.getElementById('btnSubText').classList.add('hidden');
                document.getElementById('minusBtn').classList.add('hidden');
                document.getElementById('btnProgressBg').style.width = '0%';
            }
        }

        function scrollToCurrent() {
            setTimeout(() => {
                const el = document.getElementById(`step-${appState.currentStep}`);
                if(el) el.scrollIntoView({ behavior:'smooth', block:'center'});
            }, 300);
        }

        function startTimer() {
            if(appState.isTimerRunning) return;
            appState.isTimerRunning = true;
            document.getElementById('pauseOverlay').classList.add('hidden');
            timerInterval = setInterval(() => { appState.timerSeconds++; updateTimerDisplay(); }, 1000);
        }
        function pauseTimer() { appState.isTimerRunning = false; clearInterval(timerInterval); }
        function togglePause() { 
            if(appState.isTimerRunning) { pauseTimer(); document.getElementById('pauseOverlay').classList.remove('hidden'); } else startTimer(); 
        }
        function updateTimerDisplay() {
            const m = Math.floor(appState.timerSeconds/60).toString().padStart(2,'0');
            const s = (appState.timerSeconds%60).toString().padStart(2,'0');
            document.getElementById('timerDisplay').innerText = `${m}:${s}`;
        }
        window.addEventListener('load', () => setTimeout(init, 100));
    </script>
</body>
</html>
